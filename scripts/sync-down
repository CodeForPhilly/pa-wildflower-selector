#!/bin/bash

dbName=pa-wildflower-selector
projectName=pa-wildflower-selector

# Load environment variables if .env exists
if [ -f ../.env ]; then
    export $(cat ../.env | grep -v '^#' | xargs)
fi

# Check required environment variables
if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$LINODE_BUCKET_NAME" ]; then
    echo "Error: Missing required environment variables. Please check your .env file"
    echo "Required: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, LINODE_BUCKET_NAME"
    exit 1
fi

echo "Syncing MongoDB"
if [ ! -z "$MONGODB_HOST" ]; then
    mongodump --host "$MONGODB_HOST" -d $dbName -o /tmp/mongodump.$dbName
else
    mongodump -d $dbName -o /tmp/mongodump.$dbName
fi

echo "Syncing images from Linode Object Storage"
# Ensure images directory exists
mkdir -p ./images

# Sync images from Linode bucket using the container's aws cli
docker exec $projectName aws s3 sync s3://$LINODE_BUCKET_NAME/images/ ./images/ \
    --endpoint-url ${LINODE_ENDPOINT_URL:-https://us-east-1.linodeobjects.com}

# Clean up MongoDB dump
rm -rf /tmp/mongodump.$dbName

echo "Sync completed"
echo "Images have been downloaded to ./images/"
